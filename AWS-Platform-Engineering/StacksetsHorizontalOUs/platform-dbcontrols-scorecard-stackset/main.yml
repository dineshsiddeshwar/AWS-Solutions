AWSTemplateFormatVersion: '2010-09-09'
Parameters:
  releses3bucket:
    MinLength: '1'
    MaxLength: '50'
    Type: String
    Description: CI/CD Release bucket
    ConstraintDescription: Relese S3 Bucket
  FolderName:
    MinLength: '1'
    MaxLength: '50'
    Type: String
    Description: CI/CD Release ID
    ConstraintDescription: ReleaseID
  PrivateProduction:
    Type: String
    Description: OU ID of the Private Production
  PrivateStaging:
    Type: String
    Description: OU ID of the Private Staging
  PrivateException:
    Type: String
    Description: OU ID of the Private Exception
  PublicProduction:
    Type: String
    Description: OU ID of the Public Production
  PublicStaging:
    Type: String
    Description: OU ID of the Public Staging
  PublicException:
    Type: String
    Description: OU ID of the Public Exception
  ManagedServicesBeAgile:
    Type: String
    Description: OU ID of the Managed Services BeAgile
  DataManagement:
    Type: String
    Description: OU ID of the Data Management
  HybridAccount:
    Type: String
    Description: OU ID of Hybrid Account
  Migration:
    Type: String
    Description: OU ID of Migration Accounts
  masteraccount:
    Type: String
    Description: Master Account
  CoreOU:
    Type: String
    Description: Core OU
  SharedServicesOU:
    Type: String
    Description: Shared Services OU
  ScoreCardDBTableName:
    Type: String
    Description: Enter the DPSOM DL Id
  BucketNameWithOutRegion:
    Type: String
    Description: Enter the BucketNameWithOutRegion 

Resources:
  PlatformDBControlsMainScoreCardStackset:
    Type: AWS::CloudFormation::StackSet
    DeletionPolicy: Retain
    Properties:
      TemplateURL:
        Fn::Sub:
          - https://${bucket}.s3.amazonaws.com/${releasefolder}/CloudFormation/Stackset_DBControlsScoreCard.yaml
          - bucket:
              Ref: releses3bucket
            releasefolder:
              Ref: FolderName
      StackSetName: platform-dbcontrols-scorecard-stackset
      AutoDeployment:
        Enabled: 'true'
        RetainStacksOnAccountRemoval: 'false'
      PermissionModel: SERVICE_MANAGED
      Capabilities:
        - CAPABILITY_NAMED_IAM
      StackInstancesGroup:
        - Regions:
            - us-east-1
            - eu-west-1
            - us-east-2
            - us-west-1
            - us-west-2
            - ap-south-1
            - ap-southeast-2
            - ap-southeast-1
            - eu-central-1
            - eu-west-2
            - eu-north-1
            - ap-northeast-2
            - ap-northeast-1
            - ca-central-1
          DeploymentTargets:
            OrganizationalUnitIds:
              - !Ref PublicException
              - !Ref PublicProduction
              - !Ref Migration
              - !Ref PublicStaging
              - !Ref ManagedServicesBeAgile
              - !Ref DataManagement
              - !Ref PrivateException
              - !Ref PrivateStaging
              - !Ref PrivateProduction
              - !Ref HybridAccount
              - !Ref CoreOU
              - !Ref SharedServicesOU
      OperationPreferences:
        RegionConcurrencyType: 'PARALLEL'
        FailureTolerancePercentage: 90
        MaxConcurrentPercentage: 95
      Parameters:
        - ParameterKey: masteraccount
          ParameterValue: !Ref masteraccount
        - ParameterKey: S3BucketName
          ParameterValue: !Ref BucketNameWithOutRegion 
        - ParameterKey: FolderName
          ParameterValue: !Ref FolderName  
        - ParameterKey: ScoreCardDBTableName
          ParameterValue: !Ref ScoreCardDBTableName 
      Tags:
        - Value: 'yes'
          Key: platform_donotdelete
 