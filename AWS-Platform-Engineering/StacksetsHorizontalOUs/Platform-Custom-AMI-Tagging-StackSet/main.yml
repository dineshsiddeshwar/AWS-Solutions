AWSTemplateFormatVersion: '2010-09-09'
Parameters:
  releses3bucket:
    MinLength: '1'
    MaxLength: '50'
    Type: String
    Description: CI/CD Release bucket
    ConstraintDescription: Relese S3 Bucket
  BucketNameWithOutRegion:
    MinLength: '1'
    MaxLength: '50'
    Type: String
    Description: CI/CD Release bucket for stack set
    ConstraintDescription: Relese S3 Bucket for stack set
  FolderName:
    MinLength: '1'
    MaxLength: '50'
    Type: String
    Description: CI/CD Release ID
    ConstraintDescription: ReleaseID
  PrivateProduction:
    MinLength: '1'
    MaxLength: '50'
    Type: String
    Description: Private Production OU ID
    ConstraintDescription: Private Production OU ID
  PrivateStaging:
    MinLength: '1'
    MaxLength: '50'
    Type: String
    Description: Private Staging OU ID
    ConstraintDescription: Private Staging OU ID
  PrivateException:
    MinLength: '1'
    MaxLength: '50'
    Type: String
    Description: Private Exception OU ID
    ConstraintDescription: Private Exception OU ID
  PublicProduction:
    MinLength: '1'
    MaxLength: '50'
    Type: String
    Description: Public Production OU ID
    ConstraintDescription: Public Production OU ID
  PublicStaging:
    MinLength: '1'
    MaxLength: '50'
    Type: String
    Description: Public Staging OU ID
    ConstraintDescription: Public Staging OU ID
  PublicException:
    MinLength: '1'
    MaxLength: '50'
    Type: String
    Description: Public Exception OU ID
    ConstraintDescription: Public Exception OU ID
  DataManagement:
    MinLength: '1'
    MaxLength: '50'
    Type: String
    Description: DataManagement OU ID
    ConstraintDescription: DataManagement OU ID
  HybridAccount:
    MinLength: '1'
    MaxLength: '50'
    Type: String
    Description: HybridAccount OU ID
    ConstraintDescription: HybridAccount OU ID
  Migration:
    MinLength: '1'
    MaxLength: '50'
    Type: String
    Description: Migration OU ID
    ConstraintDescription: Migration OU ID
  ManagedServicesBeAgile:
    MinLength: '1'
    MaxLength: '50'
    Type: String
    Description: ManagedServicesBeAgile OU ID
    ConstraintDescription: ManagedServicesBeAgile OU ID
  masteraccount:
    Description: Payer Account ID 
    Type: String
  DataScanning:
    AllowedValues:
      - Enabled
      - Disabled
    Default: Disabled
    Description: Enable data scanning
    Type: String
  ExternalId:
    AllowedPattern: '\S{8}-\S{4}-\S{4}-\S{4}-\S{12}'
    Description: >-
      Enter External ID, this is a nonce that will be used by our service to
      assume the WizScannerRole above
    Type: String
  OrchestratorAccountID:
    AllowedPattern: '[0-9]+'
    Description: >-
      Enter the account ID where the Wiz orchestrator will reside on, if you
      don't wish to deploy your own orchestrator cluster leave as default
    Type: String
  RolePrefix:
    Default: ''
    Description: >-
      Enter the suffix role name that will be installed on your account, the
      default is WizScannerRole (which is great)
    Type: String
  ServerlessScanning:
    AllowedValues:
      - Enabled
      - Disabled
    Default: Enabled
    Description: Enable serverless scanning
    Type: String
  RoleARN:
    Default: ''
    Description: 'Enter Role ARN, leave empty for default'
    Type: String
  WizRoleNameChild:
    Default: DEV-WizAccess-Role
    Description: >-
      Enter the role name that will be installed on your account, the default is
      WizAccess-Role
    Type: String
  DynatraceRoleNameChild:
    Default: Dynatrace_monitoring_role
    Description: >-
      Enter the role name that will be installed on your account, the default is
      Dynatrace_monitoring_role
    Type: String
  DynatraceAccountID:
    AllowedPattern: '[0-9]+'
    Description: >-
      Enter the dynatrace account id
    Type: String
  RootMonitorEventBusName:
    Type: String
    Description: Name of the Event Bus for root Monitoring in Payer Account 

Resources:
  StacksetPlatformcustomAMItagging:
    Type: AWS::CloudFormation::StackSet
    DeletionPolicy: Retain
    Properties:
      TemplateURL:
        Fn::Sub:
          - https://${bucket}.s3.amazonaws.com/${releasefolder}/CloudFormation/Custom-AMI-Tagging.yml
          - bucket:
              Ref: releses3bucket
            releasefolder:
              Ref: FolderName
      StackSetName: platform-customAMItagging-StackSet
      AutoDeployment:
        Enabled: 'true'
        RetainStacksOnAccountRemoval: 'false'
      PermissionModel: SERVICE_MANAGED
      Capabilities:
        - CAPABILITY_NAMED_IAM
        - CAPABILITY_IAM
      Description: Stackset for customAMItagging feature
      StackInstancesGroup:
        - Regions:
            - us-east-1
            - eu-west-1
            - us-east-2
            - us-west-1
            - us-west-2
            - ap-south-1
            - ap-southeast-2
            - ap-southeast-1
            - eu-central-1
            - eu-west-2
            - eu-north-1
            - ap-northeast-2
            - ap-northeast-1
            - ca-central-1
          DeploymentTargets:
            OrganizationalUnitIds:
              - !Ref PrivateProduction
              - !Ref PrivateStaging
              - !Ref PrivateException
              - !Ref PublicProduction
              - !Ref PublicStaging
              - !Ref PublicException
              - !Ref DataManagement
              - !Ref HybridAccount
              - !Ref Migration
              - !Ref ManagedServicesBeAgile
      OperationPreferences:
        RegionOrder:
          - us-east-1
          - eu-west-1
          - us-east-2
          - us-west-1
          - us-west-2
          - ap-south-1
          - ap-southeast-2
          - ap-southeast-1
          - eu-central-1
          - eu-west-2
          - eu-north-1
          - ap-northeast-2
          - ap-northeast-1
          - ca-central-1
        FailureTolerancePercentage: 100
        MaxConcurrentPercentage: 50
      Tags:
        - Value: 'yes'
          Key: platform_donotdelete
      Parameters:
        - ParameterKey: FolderName
          ParameterValue: !Ref FolderName
        - ParameterKey: S3BucketName
          ParameterValue: !Ref BucketNameWithOutRegion
        - ParameterKey: DataScanning
          ParameterValue: !Ref DataScanning
        - ParameterKey: ExternalId
          ParameterValue: !Ref ExternalId
        - ParameterKey: OrchestratorAccountID
          ParameterValue: !Ref OrchestratorAccountID
        - ParameterKey: DynatraceAccountID
          ParameterValue: !Ref DynatraceAccountID
        - ParameterKey: RolePrefix
          ParameterValue: !Ref RolePrefix
        - ParameterKey: ServerlessScanning
          ParameterValue: !Ref ServerlessScanning
        - ParameterKey: RoleARN
          ParameterValue: !Ref RoleARN
        - ParameterKey: WizRoleNameChild
          ParameterValue: !Ref WizRoleNameChild
        - ParameterKey: DynatraceRoleNameChild
          ParameterValue: !Ref DynatraceRoleNameChild        
        - ParameterKey:  masteraccount
          ParameterValue: !Ref masteraccount
        - ParameterKey:  PayerAccountEventBusName
          ParameterValue: !Ref RootMonitorEventBusName