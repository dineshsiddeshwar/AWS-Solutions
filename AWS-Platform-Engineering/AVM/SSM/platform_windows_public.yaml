---
schemaVersion: '2.2'
description: Platform Cmposite document for  Windows Agent Installations
parameters:
  cloudWatchAction:
    type: String
    description: Select the cloudwatch action from below.
    allowedValues:
      - configure
      - configure (append)
      - configure (remove)
      - start
      - status
      - stop
    default: configure
  mode:
    type: String
    description: Enter the mode of the resources.
    allowedValues:
      - ec2
      - onPremise
      - auto
    default: ec2
  optionalConfigurationSource:
    type: String
    description: Example parameter for a custom Command-type document.
    allowedValues:
      - ssm
      - default
      - all
    default: ssm
  optionalConfigurationLocationWindows:
    type: String
    description: Enter parameter name for windows.
    allowedPattern: "[a-zA-Z0-9-\"~:_@./^(*)!<>?=+]*$"
    default: platform_AmazonCloudWatch-windows
  optionalRestart:
    type: String
    description: Enter yes if you need restart.
    allowedValues:
      - "yes"
      - "no"
    default: "yes"
  action:
    type: String
    description: Enter action type.
    allowedValues:
      - Install
      - Uninstall
  installationType:
    type: String
    description: Enter Installation Type.
    allowedValues:
      - Uninstall and reinstall
      - In-place update
  name:
    type: String
    description: Enter name as an input for AWS-ConfigureAWSPackage Document.
    default: "AmazonCloudWatchAgent"
  version:
    type: String
    default: Latest
  executionTimeout:
    type: String
    description: Enter document execution timeOut.
    default: "3600"
  sourceType:
    type: String
    description: Enter the source type. Only s3 and Github are supported.
    default: "S3"
  commandLineForRapidWindows:
    type: String
    description: Enter Command Line for Rapid 7 agent installation.
  commandLineForCloudhealthWindows:
    type: String
    description: Enter Command Line for cloudhealth agent installation.
  commandLineForFalconWindows:
    type: String
    description: Enter Command Line for falcon agent installation
  commandLineForFlexeraWindows:
    type: String
    description: Enter Command Line for flexera agent installation.
  sourceInfoForRapidWindows:
    type: StringMap
    description: Enter soure path  of Rapid 7 installation  script.
  sourceInfoForFlexeraWindows:
    type: StringMap
    description: Enter soure path  of flexera installation  script.
  sourceInfoForFalconWindows:
    type: StringMap
    description: Enter soure path  of falcon installation  script.
  sourceInfoForCloudhealthWindows:
    type: StringMap
    description: Enter soure path  of Cloudhealth installation  script.
  workingDirectoryWindows:
    type: String
    description: Enter working directory for windows.
mainSteps:
- action: aws:runDocument
  name: platform_windows_agent_cloudhealth
  precondition:
    StringEquals:
      - platformType
      - Windows
  inputs:
    documentType: SSMDocument
    documentPath: "AWS-RunRemoteScript"
    documentParameters: 
      executionTimeout: '{{executionTimeout}}'
      sourceInfo: '{{sourceInfoForCloudhealthWindows}}'
      sourceType: '{{sourceType}}'
      commandLine: '{{commandLineForCloudhealthWindows}}'
      workingDirectory: '{{workingDirectoryWindows}}'
- action: aws:runDocument
  name: platform_windows_agent_flexera
  precondition:
    StringEquals:
      - platformType
      - Windows
  inputs:
    documentType: SSMDocument
    documentPath: "AWS-RunRemoteScript"
    documentParameters: 
      executionTimeout: '{{executionTimeout}}'
      sourceInfo: '{{sourceInfoForFlexeraWindows}}'
      sourceType: '{{sourceType}}'
      commandLine: '{{commandLineForFlexeraWindows}}'
      workingDirectory: '{{workingDirectoryWindows}}'
- action: aws:runDocument
  name: platform_windows_agent_falcon
  precondition:
    StringEquals:
      - platformType
      - Windows
  inputs:
    documentType: SSMDocument
    documentPath: "AWS-RunRemoteScript"
    documentParameters: 
      executionTimeout: '{{executionTimeout}}'
      sourceInfo: '{{sourceInfoForFalconWindows}}'
      sourceType: '{{sourceType}}'
      commandLine: '{{commandLineForFalconWindows}}'
      workingDirectory: '{{workingDirectoryWindows}}'
- action: aws:runDocument
  name: platform_windows_agent_rapid7
  precondition:
    StringEquals:
      - platformType
      - Windows
  inputs:
    documentType: SSMDocument
    documentPath: "AWS-RunRemoteScript"
    documentParameters: 
      executionTimeout: '{{executionTimeout}}'
      sourceInfo: '{{sourceInfoForRapidWindows}}'
      sourceType: '{{sourceType}}'
      commandLine: '{{commandLineForRapidWindows}}'
      workingDirectory: '{{workingDirectoryWindows}}'
- action: aws:runDocument
  name: platform_cloudwatch_windows
  precondition:
    StringEquals:
      - platformType
      - Windows
  inputs:
    documentType: SSMDocument
    documentPath: "AWS-ConfigureAWSPackage"
    documentParameters: 
      action: '{{action}}'
      name: '{{name}}'
      installationType: '{{installationType}}'
      version: '{{version}}'
- action: aws:runDocument
  name: platform_cloudwatch_windowspost
  precondition:
    StringEquals:
      - platformType
      - Windows
  inputs:
    documentType: SSMDocument
    documentPath: "AmazonCloudWatch-ManageAgent"
    documentParameters: 
      action: '{{cloudWatchAction}}'
      mode: '{{mode}}'
      optionalConfigurationLocation: '{{optionalConfigurationLocationWindows}}'
      optionalConfigurationSource: '{{optionalConfigurationSource}}'
      optionalRestart: '{{optionalRestart}}'