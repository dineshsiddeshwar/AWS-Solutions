---
schemaVersion: '2.2'
description: Platform composite document for  Domain Join
parameters:
  cloudWatchAction:
    type: String
    description: Select the cloudwatch action from below.
    allowedValues:
      - configure
      - configure (append)
      - configure (remove)
      - start
      - status
      - stop
    default: configure
  mode:
    type: String
    description: Enter the mode of the resources.
    allowedValues:
      - ec2
      - onPremise
      - auto
    default: ec2
  optionalConfigurationSource:
    type: String
    description: Example parameter for a custom Command-type document.
    allowedValues:
      - ssm
      - default
      - all
    default: ssm
  optionalConfigurationLocationLinux:
    type: String
    description: Enter parameter name for linux.
    allowedPattern: "[a-zA-Z0-9-\"~:_@./^(*)!<>?=+]*$"
    default: platform_AmazonCloudWatch-Linux
  optionalRestart:
    type: String
    description: Enter yes if you need restart.
    allowedValues:
      - "yes"
      - "no"
    default: "yes"
  action:
    type: String
    description: Enter action type.
    allowedValues:
      - Install
      - Uninstall
  installationType:
    type: String
    description: Enter Installation Type.
    allowedValues:
      - Uninstall and reinstall
      - In-place update
  name:
    type: String
    description: Enter name as an input for AWS-ConfigureAWSPackage Document.
    default: "AmazonCloudWatchAgent"
  version:
    type: String
    default: Latest
  commandLineForRapidLinux:
    type: String
    description: Enter command line for rapid 7 installation.
    default: "./DownloadAndInstallRapid7AgentLinux.sh"
  commandLineForCloudHealthLinux:
    type: String
    description: Enter command line for Cloudhealth installation.
    default: "./downloadandinstallcloudhealth.sh"
  commandLineForFalconLinux:
    type: String
    description: Enter command line for Falcon installation.
    default: "./downloadandinstallfalcon.sh"
  commandLineForFlexeraLinux:
    type: String
    description: Enter command line for Flexera installation.
    default: "./DownloadAndInstallFlexeraAgentLinux.sh"
  executionTimeout:
    type: String
    description: Enter document execution timeOut.
    default: "3600"
  sourceInfoForRapidLinux:
    type: StringMap
    description: Enter Source Path for Rapid 7 .
  sourceInfoForFlexeraLinux:
    type: StringMap
    description: Enter Source Path for Flexera.
  sourceInfoForFalconLinux:
    type: StringMap
    description: Enter Source Path for Falcon.
  sourceInfoForCloudhealthLinux:
    type: StringMap
    description: Enter Source Path for Cloudhealth.
  sourceType:
    type: String
    description: Enter the source type. Only s3 and Github are supported.
    default: "S3"
  workingDirectoryLinux:
    type: String
    description: Enter working directory For linux.
    default: "/var/tmp"
mainSteps:
- action: aws:runDocument
  name: platform_linux_agent_cloudhealth
  precondition:
    StringEquals:
      - platformType
      - Linux
  inputs:
    documentType: SSMDocument
    documentPath: "AWS-RunRemoteScript"
    documentParameters: 
      executionTimeout: '{{executionTimeout}}'
      sourceInfo: '{{sourceInfoForCloudhealthLinux}}'
      sourceType: '{{sourceType}}'
      commandLine: '{{commandLineForCloudHealthLinux}}'
      workingDirectory: '{{workingDirectoryLinux}}'
- action: aws:runDocument
  name: platform_linux_agent_flexera
  precondition:
    StringEquals:
      - platformType
      - Linux
  inputs:
    documentType: SSMDocument
    documentPath: "AWS-RunRemoteScript"
    documentParameters: 
      executionTimeout: '{{executionTimeout}}'
      sourceInfo: '{{sourceInfoForFlexeraLinux}}'
      sourceType: '{{sourceType}}'
      commandLine: '{{commandLineForFlexeraLinux}}'
      workingDirectory: '{{workingDirectoryLinux}}'
- action: aws:runDocument
  name: platform_linux_agent_falcon
  precondition:
    StringEquals:
      - platformType
      - Linux
  inputs:
    documentType: SSMDocument
    documentPath: "AWS-RunRemoteScript"
    documentParameters: 
      executionTimeout: '{{executionTimeout}}'
      sourceInfo: '{{sourceInfoForFalconLinux}}'
      sourceType: '{{sourceType}}'
      commandLine: '{{commandLineForFalconLinux}}'
      workingDirectory: '{{workingDirectoryLinux}}'
- action: aws:runDocument
  name: platform_linux_agent_rapid7
  precondition:
    StringEquals:
      - platformType
      - Linux
  inputs:
    documentType: SSMDocument
    documentPath: "AWS-RunRemoteScript"
    documentParameters: 
      executionTimeout: '{{executionTimeout}}'
      sourceInfo: '{{sourceInfoForRapidLinux}}'
      sourceType: '{{sourceType}}'
      commandLine: '{{commandLineForRapidLinux}}'
      workingDirectory: '{{workingDirectoryLinux}}'
- action: aws:runDocument
  name: platform_cloudwatch_linux_pre
  precondition:
    StringEquals:
      - platformType
      - Linux
  inputs:
    documentType: SSMDocument
    documentPath: "AWS-ConfigureAWSPackage"
    documentParameters: 
      action: '{{action}}'
      name: '{{name}}'
      installationType: '{{installationType}}'
      version: '{{version}}'
- action: aws:runDocument
  name: platform_cloudwatch_linux
  precondition:
    StringEquals:
      - platformType
      - Linux
  inputs:
    documentType: SSMDocument
    documentPath: "AmazonCloudWatch-ManageAgent"
    documentParameters: 
      action: '{{cloudWatchAction}}'
      mode: '{{mode}}'
      optionalConfigurationLocation: '{{optionalConfigurationLocationLinux}}'
      optionalConfigurationSource: '{{optionalConfigurationSource}}'
      optionalRestart: '{{optionalRestart}}'