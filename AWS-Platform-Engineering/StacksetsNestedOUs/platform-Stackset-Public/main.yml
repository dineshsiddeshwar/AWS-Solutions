AWSTemplateFormatVersion: '2010-09-09'
Parameters:
  releses3bucket:
    MinLength: '1'
    MaxLength: '50'
    Type: String
    Description: CI/CD Release bucket
    ConstraintDescription: Relese S3 Bucket
  BucketNameWithOutRegion:
    MinLength: '1'
    MaxLength: '50'
    Type: String
    Description: CI/CD Release bucket for stack set
    ConstraintDescription: Relese S3 Bucket for stack set
  FolderName:
    MinLength: '1'
    MaxLength: '50'
    Type: String
    Description: CI/CD Release ID
    ConstraintDescription: ReleaseID
  ProdPublic:
    MinLength: '1'
    MaxLength: '50'
    Type: String
    Description: Prod Public OU ID
    ConstraintDescription: Prod Public OU ID
  NonProdPublic:
    MinLength: '1'
    MaxLength: '50'
    Type: String
    Description: Non Prod Public OU ID
    ConstraintDescription: Non Prod Public OU ID
  RESPCMigration:
    MinLength: '1'
    MaxLength: '50'
    Type: String
    Description: RESPCMigration OU ID
    ConstraintDescription: RESPCMigration OU ID
  IRMAccount:
    Type: String
    Description: IRM IP Account
  IRMEnvironment:
    Description: IRM Environment type.
    Type: String
    AllowedValues:
      - prod
      - uat
      - dev
  EnvType:
    Description: Environment type.
    Type: String
    AllowedValues:
      - prod
      - acceptance
      - dev
  BucketNameWithOutRegion:
    MinLength: '1'
    MaxLength: '50'
    Type: String
    Description: CI/CD Release bucket
    ConstraintDescription: Relese S3 Bucket
  GridMasterAPIGEE:
     Description: APIGEE Integration URL Point Shell on-pren Infoblox Gridmaster
     Type: String
  APIGEEAuthorizationURL:
     Description: APIGEE Integration Authorization URL
     Type: String
  APIGEEAuthorizationToken:
     Description: APIGEE Integration Authorization Token
     Type: String
  APIGEEAuthorizationTokenExtnl:
     Description: APIGEE Integration Authorization Token for Extnl
     Type: String
  GridMasterAPIVersion:
     Description: Infoblox GridMaster API Version
     Type: String
  ADOReleaseId:
     Description: DNS Zone Delegation ADO Release Id
     Type: String
  ADOAPIURL:
     Description: DNS Zone Delegation ADO API URL
     Type: String
  ADOAuthorizationToken:
     Description: ADO Authorization Token
     Type: String
  DNSSecretARN:
     Description: git hub ssecret arn
     Type: String
  DNSTemplateid:
     Description: git hub snow template id
     Type: String
  DNSRepoName:
     Description: git hub repo name 
     Type: String
  DNSOwnerName:
     Description: git hub owner name
     Type: String
  DNSJobStepName:
     Description: git hub job name and 3 rd step of the run name
     Type: String
  GithubAppID:
     Description: Git Hub API ID
     Type: String
  GithubWorkflowID:
     Description: git hub workflow ID
     Type: String
Resources:
  StacksetPlatformPublic:
    Type: AWS::CloudFormation::StackSet
    DeletionPolicy: Retain
    Properties:
      TemplateURL:
        Fn::Sub:
          - https://${bucket}.s3.amazonaws.com/${releasefolder}/CloudFormation/Stackset_Public.yml
          - bucket:
              Ref: releses3bucket
            releasefolder:
              Ref: FolderName
      StackSetName: Nested-OU-Platform-Public
      AutoDeployment:
        Enabled: 'true'
        RetainStacksOnAccountRemoval: 'false'
      PermissionModel: SERVICE_MANAGED
      Capabilities:
        - CAPABILITY_NAMED_IAM
      StackInstancesGroup:
        - Regions:
            - us-east-1
            - eu-west-1
            - us-east-2
            - us-west-1
            - us-west-2
            - ap-south-1
            - ap-southeast-2
            - ap-southeast-1
            - eu-central-1
            - eu-west-2
            - eu-north-1
            - ap-northeast-2
            - ap-northeast-1
            - ca-central-1
          DeploymentTargets:
            OrganizationalUnitIds:
              - !Ref ProdPublic
              - !Ref NonProdPublic
              - !Ref RESPCMigration
      OperationPreferences:
        RegionConcurrencyType: 'SEQUENTIAL'
        RegionOrder:
          - us-east-1
          - eu-west-1
          - us-east-2
          - us-west-1
          - us-west-2
          - ap-south-1
          - ap-southeast-2
          - ap-southeast-1
          - eu-central-1
          - eu-west-2
          - eu-north-1
          - ap-northeast-2
          - ap-northeast-1
          - ca-central-1
        FailureTolerancePercentage: 100
        MaxConcurrentPercentage: 50
      Tags:
        - Value: 'yes'
          Key: platform_donotdelete
      Parameters:
        - ParameterKey: IRMAccount
          ParameterValue: !Ref IRMAccount
        - ParameterKey: IRMEnvironment
          ParameterValue: !Ref IRMEnvironment
        - ParameterKey: EnvType
          ParameterValue: !Ref EnvType
        - ParameterKey: BucketNameWithOutRegion
          ParameterValue: !Ref BucketNameWithOutRegion
        - ParameterKey: ReleaseID
          ParameterValue: !Ref FolderName
        - ParameterKey: GridMasterAPIGEE
          ParameterValue: !Ref GridMasterAPIGEE
        - ParameterKey: APIGEEAuthorizationURL
          ParameterValue: !Ref APIGEEAuthorizationURL
        - ParameterKey: APIGEEAuthorizationToken
          ParameterValue: !Ref APIGEEAuthorizationToken
        - ParameterKey: APIGEEAuthorizationTokenExtnl
          ParameterValue: !Ref APIGEEAuthorizationTokenExtnl
        - ParameterKey: GridMasterAPIVersion
          ParameterValue: !Ref GridMasterAPIVersion
        - ParameterKey: ADOReleaseId
          ParameterValue: !Ref ADOReleaseId
        - ParameterKey: ADOAPIURL
          ParameterValue: !Ref ADOAPIURL
        - ParameterKey: ADOAuthorizationToken
          ParameterValue: !Ref ADOAuthorizationToken
        - ParameterKey: GithubAppID
          ParameterValue: !Ref GithubAppID
        - ParameterKey: GithubWorkflowID
          ParameterValue: !Ref GithubWorkflowID
        - ParameterKey: DNSSecretARN
          ParameterValue: !Ref DNSSecretARN
        - ParameterKey: DNSTemplateid
          ParameterValue: !Ref DNSTemplateid
        - ParameterKey: DNSRepoName
          ParameterValue: !Ref DNSRepoName
        - ParameterKey: DNSOwnerName
          ParameterValue: !Ref DNSOwnerName
        - ParameterKey: DNSJobStepName
          ParameterValue: !Ref DNSJobStepName