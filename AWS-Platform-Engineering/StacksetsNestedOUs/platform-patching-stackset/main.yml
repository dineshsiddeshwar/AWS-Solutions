AWSTemplateFormatVersion: '2010-09-09'
Parameters:
  releses3bucket:
    MinLength: '1'
    MaxLength: '50'
    Type: String
    Description: CI/CD Release bucket
    ConstraintDescription: Relese S3 Bucket
  BucketNameWithOutRegion:
    MinLength: '1'
    MaxLength: '50'
    Type: String
    Description: CI/CD Release bucket for stack set
    ConstraintDescription: Relese S3 Bucket for stack set
  FolderName:
    MinLength: '1'
    MaxLength: '50'
    Type: String
    Description: CI/CD Release ID
    ConstraintDescription: ReleaseID
  Prod:
    MinLength: '1'
    MaxLength: '50'
    Type: String
    Description: Prod OU ID
    ConstraintDescription: Prod OU ID
  NonProd:
    MinLength: '1'
    MaxLength: '50'
    Type: String
    Description: Non Prod OU ID
    ConstraintDescription: Non Prod OU ID
    ConstraintDescription: Shared Services OU ID
  Exceptions:
    MinLength: '1'
    MaxLength: '50'
    Type: String
    Description: Exceptions OU ID
    ConstraintDescription: Exceptions OU ID
  RESPCMigration:
    MinLength: '1'
    MaxLength: '50'
    Type: String
    Description: RESPCMigration OU ID
    ConstraintDescription: RESPCMigration OU ID
  PatchingTemplateStackAccountId:  
    Type : 'String'
    Description: 'The account ID of the patching template.'    
  ExecutionLogsBucketName:
    Type : 'String'
    Description: 'The name of the S3 bucket used to store execution logs centrally.'
  ResouceSyncBucketName:
    Type : 'String'
    Description: 'The name of the S3 bucket used to store resource data sync details'
  PatchingTemplateStackRegion:
    Type : 'String'
    Description: 'The region of the patching template.'
  ManagedInstanceDataEncryptionKey:
    Type : 'String'
    Description: 'The ARN of the KMS key used to encrypt resource data sync logs'
  BaselineOverrideBucket:
    Type : 'String'
    Description: The ARN of the S3 bucket used to store patch baseline override list.
  ServiceCatalogLaunchRoleName:
    Type : 'String'
    Description: The name of the Service Catalog launch role
  CronValue:
    Type : 'String'
    Description: cron of the patching window.
  MasterAccountId:
    Type : 'String'
    Description: payer account id
Resources:
  StacksetPlatformPatching:
    Type: AWS::CloudFormation::StackSet
    DeletionPolicy: Retain
    Properties:
      TemplateURL:
        Fn::Sub:
          - https://${bucket}.s3.amazonaws.com/${releasefolder}/CloudFormation/platform-patching-stackset.yml
          - bucket:
              Ref: releses3bucket
            releasefolder:
              Ref: FolderName
      StackSetName: Nested-OU-Platform-Patching
      AutoDeployment:
        Enabled: 'true'
        RetainStacksOnAccountRemoval: 'false'
      PermissionModel: SERVICE_MANAGED
      Capabilities:
        - CAPABILITY_NAMED_IAM
        - CAPABILITY_IAM
      Description: Stackset for patching compliance resources
      StackInstancesGroup:
        - Regions:
            - us-east-1
            - eu-west-1
            - us-east-2
            - us-west-1
            - us-west-2
            - ap-south-1
            - ap-southeast-2
            - ap-southeast-1
            - eu-central-1
            - eu-west-2
            - eu-north-1
            - ap-northeast-2
            - ap-northeast-1
            - ca-central-1
          DeploymentTargets:
            OrganizationalUnitIds:
              - !Ref RESPCMigration
              - !Ref Prod
              - !Ref NonProd
              - !Ref Exceptions
      OperationPreferences:
        RegionConcurrencyType: 'PARALLEL'
        FailureTolerancePercentage: 100
        MaxConcurrentPercentage: 50
      Tags:
        - Value: 'yes'
          Key: platform_donotdelete
      Parameters:
        - ParameterKey: S3BucketName
          ParameterValue: !Ref BucketNameWithOutRegion
        - ParameterKey: FolderName
          ParameterValue: !Ref FolderName
        - ParameterKey: ExecutionLogsS3BucketPrefix
          ParameterValue: 'inventory-execution-logs'
        - ParameterKey: ResourceDataSyncName
          ParameterValue: 'InventoryData'
        - ParameterKey: PatchingTemplateStackAccountId
          ParameterValue: !Ref PatchingTemplateStackAccountId
        - ParameterKey: ExecutionLogsBucketName
          ParameterValue: !Ref ExecutionLogsBucketName          
        - ParameterKey: ResouceSyncBucketName
          ParameterValue: !Ref ResouceSyncBucketName
        - ParameterKey: PatchingTemplateStackRegion
          ParameterValue: !Ref PatchingTemplateStackRegion
        - ParameterKey: ManagedInstanceDataEncryptionKey
          ParameterValue: !Ref ManagedInstanceDataEncryptionKey
        - ParameterKey: BaselineOverrideBucket
          ParameterValue: !Ref BaselineOverrideBucket               
        - ParameterKey: ServiceCatalogLaunchRoleName
          ParameterValue: !Ref ServiceCatalogLaunchRoleName
        - ParameterKey: CronValue
          ParameterValue: !Ref CronValue
        - ParameterKey: MasterAccountId
          ParameterValue: !Ref MasterAccountId