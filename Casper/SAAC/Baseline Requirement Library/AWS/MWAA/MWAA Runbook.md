# Amazon Managed Workflows for Apache Airflow (MWAA) Runbook
## Cybersecurity Control Alignment
---
Summary of changes:

1. Added new controls
2. Updated the control ID and description for each requirement.
3. Added new column for 'Security Domain', 'Default' and associated runbook.
4. Updated security mappings


**Generated By: EY Security Team**

**Deployment Phase:**  

**Service Type:Application Integration** 

Last Update: 04/12/2022

Table of Contents

- Overview

- Cloud Security Requirements

  - 1. [Ensure to enforce least privilege permission policies](#1ensure-to-enforce-least-privilege-permission-policies)
  - 2. [Ensure to attach Service-linked role policy to Amazon MWAA](#2ensure-to-attach-service-linked-role-policy-to-amazon-mwaa)
  - 3. [Ensure to create execution role for Amazon MWAA](#3ensure-to-create-execution-role-for-amazon-mwaa)
  - 4. [Ensure to enable private access mode for Apache Airflow](#4ensure-to-enable-private-access-mode-for-apache-airflow)
  - 5. [Ensure data are encrypted at rest using organization managed key(CMK)](#5ensure-data-are-encrypted-at-rest-using-organization-managed-key-cmk)
  - 6. [Ensure that 'Secure transfer required' is set to 'Enabled' in Apache Airflow](#6ensure-that-secure-transfer-required-is-set-to-enabled-in-apache-airflow)
  - 7. [Ensure to configure an Apache Airflow connection using a Secrets Manager secret key](#7ensure-to-configure-an-apache-airflow-connection-using-a-secrets-manager-secret-key)
  - 8. [Ensure to enable API and user activity logging with AWS CloudTrail](#8ensure-to-enable-api-and-user-activity-logging-with-aws-cloudtrail)
  - 9. [Ensure to enable CloudWatch metrics for Amazon MWAA](#9ensure-to-enable-cloudwatch-metrics-enabled-for-amazon-mwaa)
  - 10. [Ensure Amazon MWAA environment's metadatabase and DAGs are secure](#10ensure-amazon-environment's-metadatabase-and-dags-are-secure)
  - 11. [Ensure MWAA environment run in a private network](#11ensure-mwaa-environment-run-in-a-private-network)
  - 12. [Ensure VPC endpoints are used to access airflow service](#12ensure-vpc-endpoints-are-used-to-access-airflow-service)
  - 13. [Ensure resource tagging is added to Amazon MWAA](#13ensure-resource-tagging-is-added-to-amazon-mwaa)

- [Endnotes](#endnotes)
- [Capital Group Glossory](#capital-group-glossory)

###  **Overview**
--------------
Amazon Managed Workflows for Apache Airflow (MWAA) is a managed orchestration service for Apache Airflow that makes it easier to setup and operate end-to-end data pipelines in the cloud at scale. Apache Airflow is an open-source tool used to programmatically author, schedule, and monitor sequences of processes and tasks referred to as "workflows." With Amazon MWAA, you can use Airflow and Python to create workflows without having to manage the underlying infrastructure for scalability, availability, and security. Amazon MWAA automatically scales its workflow execution capacity to meet your needs, and is integrated with AWS security services to help provide you with fast and secure access to your data.

![archi](https://docs.aws.amazon.com/mwaa/latest/userguide/images/mwaa-architecture.png)

| Control Number | Cloud Baseline Security Requirements                                                                                |
| -------------- | --------------------------------------------------------------------------------------------------------------------|
| 1	           | Ensure to enforce least privilege permission policies                                                               |
| 2	           | Ensure to attach Service-linked role policy to Amazon MWAA                                                          |
| 3	           | Ensure to create execution role for Amazon MWAA                                                                     |
| 4	           | Ensure to enable private access mode for Apache Airflow                                                             |
| 5	           | Ensure data are encrypted at rest using organization managed key(CMK)                                               |
| 6	           | Ensure that 'Secure transfer required' is set to 'Enabled' in Apache Airflow                                        |
| 7	           | Ensure to configure an Apache Airflow connection using a Secrets Manager secret key                                 |
| 8	           | Ensure to enable API and user activity logging with AWS CloudTrail                                                  |
| 9	           | Ensure to enable CloudWatch metrics for Amazon MWAA                                                                 |
| 10	           | Ensure Amazon MWAA environment's metadatabase and DAGs are secure                                                   |
| 11	           | Ensure MWAA environment run in a private network                                                                    |
| 12	           | Ensure VPC endpoints are used to access airflow service                                                             |
| 13	           | Ensure resource tagging is added to Amazon MWAA                                                                     |

**Use Case Examples:**
- Enable Complex Workflows
- Coordinate Extract, Transform, and Load (ETL) Jobs
- Prepare Machine Learning (ML) Data


### Cloud Security Requirements ###

---
#### **1.Enforce least privilege permission policies** ####
**Security Control::**

| Requirement Id | Description| Security domain | Default | Associated Runbook|
| ------- | ----------|------- | -----|----|
| CS0012298 | Access to change cloud identity access and service control policies is restricted to authorized cloud administrative personnel| IAM | Not Enabled | None|

**Why?**

EY utlizes the least privilege model when using IAM for Amazon MWAA services. EY's standards require that users only have the minimum permissions assigned based on the need for them to perform tasks. The resources and services used in an Amazon MWAA environment are not accessible to all IAM entities, such as users, roles, or groups. You must create a policy that grants your Apache Airflow users permission to access these resources. For example, you need to grant access to Apache Airflow development team.
Implementing least privilege access is fundamental in reducing security risk and the impact that could result from errors or malicious intent.


#### **2.Ensure to attach Service-linked role policy to Amazon MWAA** ####

**Security Control::**

| Requirement Id | Description | Security domain |Default | Associated Runbook|
| ------- | ----------|------- | -----| ----|
| CS0012298 | Access to change cloud identity access and service control policies is restricted to authorized cloud administrative personnel |IAM|Not Enabled | None|

**Why?** 

Amazon MWAA creates a service-linked role in AWS account to allow Amazon MWAA to use other AWS services used by  environment during its provisioning. The service role enables permission to the following AWS services:

  - Amazon ECR – where your environment's Apache Airflow image is hosted.

  - CloudWatch Logs – to create log groups for Apache Airflow logs.

  - Amazon EC2 – to create the  Amazon VPC endpoint and Elastic Network Interfaces (ENIs).

  #### **3.Ensure to create execution role for Amazon MWAA** ####

  **Security Control::**
  | Requirement Id | Description | Security domain| Default | Associated Runbook|
| ------- | ---------- | ------- | -----|---|
| CS0012298  | Access to change cloud identity access and service control policies is restricted to authorized cloud administrative personnel |IAM| Not Enabled | None|

  **Why?**

  EY security team recommends to create a new execution role or use an existing one to grant Amazon MWAA permission to invoke the resources of other AWS services on your behalf. This can include following resources:

  - Amazon CloudWatch – to send Apache Airflow metrics and logs.

  - Amazon S3 – to parse your environment's DAG code and supporting files such as a requirements.txt.

  - Amazon SQS – to queue your environment's Apache Airflow tasks in an Amazon SQS queue owned by Amazon MWAA.

  - AWS KMS – for your environment's data encryption (using either an AWS owned key or your Customer managed key).


#### **4.Ensure to enable private access mode for Apache Airflow** ####

**Security Control::**
| Requirement Id | Description | Security domain| Default | Associated Runbook|
| ------- | ---------- | ------- | -----|---|
| CS0012300 | Cloud products and services must be deployed on private subnets and public access must be disabled for these services.| Network Security | Not Enabled | None|

**Why?**

The Amazon Managed Workflows for Apache Airflow (MWAA) console contains built-in options to configure private or public routing to the Apache Airflow Web server on your environment. As per security best practice make sure to choose the option of configuring Apache Airflow Web server in private routing mode.

#### **5.Ensure data are encrypted at rest using organization managed key(CMK)** ####

**Security Control::**

| Requirement Id | Description | Security domain| Default | Associated Runbook|
| ------- | ---------- | ------- | -----|---|
| CS0012168  | Strong encryption key management controls are in place for cloud provider services to protect data at rest and in transit. | Data Protection|Enabled | None|

**Why?**

Cloud Security standards require that we ensure that the AWS services that hold sensitive, critical or any other data are encrypted to fulfill compliance requirements for data-at-rest to defend against brute-force and cyber-attacks, including malware and ransomware.


#### **6.Ensure that 'Secure transfer required' is set to 'Enabled' in Apache Airflow** ####

**Security Control::**

| Requirement Id | Description | Security domain| Default | Associated Runbook|
| ------- | ---------- | ------- | -----|---|
| CS0012261|Cloud based data in transit must be encrypted with enterprise approved algorithms. | Data Protection | Not Enabled|None|                                             

**Why?**

When Apache airflow are not configured to strictly require SSL connections, the communication between the clients (users, applications) and these services is vulnerable to eavesdropping and man-in-the-middle (MITM) attacks. EY strongly recommends enforcing SSL-only access by denying all regular, unencrypted HTTP requests to the airflpw when dealing with sensitive or private data. EY also recommends to use the latest TLS version while enabling encryption in transit.

#### **7.Ensure to configure an Apache Airflow connection using a Secrets Manager secret key** ####

**Security Control::**
| Requirement Id | Description | Security domain| Default | Associated Runbook|
| ------- | ---------- | ------- | -----|---|
|||Data Protection||Not Enabled|None|

**Why?**

EY requires that all locals and generic credentials be secured using an approved vaulting solution.Amazon MWAA is integrated with AWS Secrets Manager,a service which is used to protect secrets needed to access applications, services, and IT resources. As per security best practices use AWS Secrets Manager to securely store secrets for Apache Airflow variables and an Apache Airflow connection on Amazon MWAA.


#### **8.Ensure to enable API and user activity logging with AWS CloudTrail** ####

**Security Control::**
| Requirement Id | Description | Security domain| Default | Associated Runbook|
| ------- | ---------- | ------- | -----|---|
|  | |Security Logging|Not Enabled | Cloud trail Runbook |

**Why?**

Amazon MWAA is integrated with Amazon CloudTrail,a service that provides a record of actions taken by a user, role, or an AWS service in Amazon MWAA. Using the information collected by CloudTrail, the security team can determine the request that was made to Amazon MWAA, the IP address from which the request was made, who made the request, when it was made, and additional details available in audit logs.

#### **9.Ensure to enable CloudWatch metrics for Amazon MWAA** ####

**Security Control::**

| Requirement Id | Description | Security domain| Default | Associated Runbook|
| ------- | ---------- | ------- | -----|---|
|||Security Logging|Cloudwatch Runbook|

**Why?**

Amazon MWAA is integrated with Amazon Cloudwatch, a service which is a metrics repository for AWS services that allow security teams to retrieve statistics based on the metrics and dimensions published by a Amazon MWAA. EY security team recommends to use these metrics to configure alarms, calculate statistics and then present the data in a dashboard which helps to assess the health of Amazon MWAA environment. Apache Airflow exposes metrics for a number of processes, including the number of DAG processes, DAG bag size, currently running tasks, task failures, and successes,Web server, Worker logs etc.

#### **10.Ensure Amazon MWAA environment's metadatabase and DAGs are secure** ####

**Security Control::**

| Requirement Id | Description | Security domain| Default | Associated Runbook|
| ------- | ---------- | ------- | -----|---|
||| IAM | Not Enabled| None|

**Why?**

Apache Airflow is not multi-tenant. While there are access control measures to limit some features to specific users, which Amazon MWAA implements, DAG creators do have the ability to write DAGs that can change Apache Airflow user privileges and interact with the underlying metadatabase.


#### **11.Ensure MWAA environment run in a private network** ####

**Security Control::**

| Requirement Id | Description | Security domain| Default | Associated Runbook|
| ------- | ---------- | ------- | -----|---|
|CS0012300| Cloud products and services must be deployed on private subnets and public access must be disabled for these services| Network Security |Not Enabled| None|

**Why?**

EY standard's recommend to create the Amazon MWAA environment in Private subnet as it gives cloud security and the ability to scale dynamically by providing fine-grained control over  virtual infrastructure and network traffic segmentation.

#### **12.Ensure VPC endpoints are used to access airflow service** ####

**Security Control::**

| Requirement Id | Description | Security domain| Default | Associated Runbook|
| ------- | ---------- | ------- | -----|---|
|CS0012300| Cloud products and services must be deployed on private subnets and public access must be disabled for these services|Network Security | Not Enabled|None|

**Why?**

VPC Controls provide reasonable assurance that direct access (with provided credentials) is not allowed to the AWS environment from outside the corporate network or AWS backbone. A VPC endpoint for Amazon MWAA enables resources in VPC to use private IP addresses to access Amazon MWAA with no exposure to the public internet. You use endpoint policies to control access to Amazon MWAA.   When you create a VPC endpoint for Amazon MWAA, any requests to  Amazon MWAA endpoint within the Region (for example, com.amazonaws.us-east-1.airflow.api) are routed to a private  endpoint within the Amazon network.

#### **13.Ensure resource tagging is added to Amazon MWAA** ####

**Security Control::**

| Requirement Id | Description | Security domain| Default | Associated Runbook|
| ------- | ---------- | ------- | -----|---|
|||Asset Management|Not Enabled|None|

**What, Why & How?**

Identification of your IT assets is a crucial aspect of governance and security. You need to have visibility of all your Amazon MWAA resources to
assess their security posture and take action on potential areas of weakness.

Tagging resources in the cloud is an easy way for teams to provide information related to who owns the resource, what the resource is used for, as well as other important information related to the deployment lifecycle of the resource. EY has mandated that all cloud resources are to be tagged with for cross-team use. 

## Endnotes ##
---

**Resources**
1. https://docs.aws.amazon.com/mwaa/latest/userguide/what-is-mwaa.html
2. https://docs.aws.amazon.com/mwaa/latest/userguide/security.html

## Capital Group Glossory ##
---

**Data** - Digital pieces of information stored or transmitted for use with an information system from which understandable information is
derived. Items considered to be data are: Source code, meta-data, build artifacts, information input and output.

**Information System** - An organized assembly of resources and procedures for the collection, processing, maintenance, use, sharing,
dissemination, or disposition of information. All systems, platforms, compute instances including and not limited to physical and virtual
client endpoints, physical and virtual servers, software containers, databases, Internet of Things (IoT) devices, network devices,
applications (internal and external), Serverless computing instances (i.e. AWS Lambda), vendor provided appliances, and third-party
platforms, connected to the Capital Group network or used by Capital Group users or customers.

**Log** - A record of the events occurring within information systems and networks. Logs are composed of log entries; each entry contains
information related to a specific event that has occurred within a system or network.

**Information** - communication or representation of knowledge such as facts, data, or opinions in any medium or form, including textual,
numerical, graphic, cartographic, narrative, or audiovisual.

**Cloud Computing** - A model for enabling ubiquitous, convenient, on-demand network access to a shared pool of configurable computing
resources (e.g., networks, servers, storage, applications, and services) that can be rapidly provisioned and released with minimal
management effort or service provider interaction.

**Vulnerability**- Weakness in an information system, system security procedures, internal controls, or implementation that could be exploited
or triggered by a threat source. Note: The term weakness is synonymous for deficiency. Weakness may result in security and/or privacy
risks.
