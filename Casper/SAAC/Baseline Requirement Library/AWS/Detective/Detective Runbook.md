<!-- omit in toc -->
# Amazon Detective - Security Baseline Requirement
<!-- omit in toc -->
## Baseline security configuration requirement for AWS services 
---

Summary of changes: 
1. Added new controls
2. Updated the security control mappings

**Generated By: EY Security Team**

**Service Type: Security, Identity, & Compliance**

**Deployment Phase: Service Discovery** 

**Last Update: 07/20/2022**

## Table of Contents  <!-- omit in toc -->
<!-- TOC -->
- [Overview](#overview)
  - [Use Case Examples:](#use-case-examples)
- [Cloud Security Requirements](#cloud-security-requirements)
  - [1. Ensure AWS Detective users and roles are following least privilege model](#1-ensure-aws-detective-users-and-roles-are-following-least-privilege-model)
  - [2. Ensure CloudTrail logging is enabled for AWS Detective](#2-ensure-cloudtrail-logging-is-enabled-for-aws-detective)
  - [3. Ensure to send/receive invitation to Detective behavior graph only by organization owned member accounts](#3-ensure-to-sendreceive-invitation-to-detective-behavior-graph-only-by-organization-owned-member-accounts)
  - [4. Ensure only organization owned admin accounts are allowed to enable/disable AWS Detective](#4-ensure-only-organization-owned-admin-accounts-are-allowed-to-enabledisable-aws-detective)
  - [5. Ensure AWS Detective uses standard organizational resource tagging method](#5-ensure-aws-detective-uses-standard-organizational-resource-tagging-method)
- [Endnotes](#endnotes)
  - [Resources](#resources)
  - [Glossary](#glossary)
<!-- /TOC -->

##  Overview
Amazon Detective makes it easy to analyze, investigate, and quickly identify the root cause of potential security issues or suspicious activities. Amazon Detective automatically collects log data from AWS resources and uses machine learning, statistical analysis, and graph theory to build a linked set of data that enables  to easily conduct faster and more efficient security investigations.

![archi](https://d1.awsstatic.com/re19/Diagram_Detective.93ebed7d2e3452fc03c6496bd7faf5b8f2ef9a6e.png)


| Control Number | Cloud Baseline Security Requirements                                                                        |
| -------------- | ----------------------------------------------------------------------------------------------------------- |
| 1              | Ensure AWS Detective users and roles are following least privilege model                                    |
| 2              | Ensure CloudTrail logging is enabled for AWS Detective                                                      |
| 3              | Ensure to send/receive invitation to Detective behavior graph only by organization owned member accounts    |
| 4              | Ensure only organization owned admin accounts are allowed to enable/disable AWS Detective                   |
| 5              | Ensure AWS Detective uses standard organizational resource tagging method                                   |

### Use Case Examples:
- Build hybrid networks
- Extend existing network
- Manage large datasets

## Cloud Security Requirements ##

### 1. Ensure AWS Detective users and roles are following least privilege model

**Security control mapping:** <br>
| Control Number | Control Statement | Security Domain | Default | Associated Runbook |CVSS Severity|
| ------------------ | ------------| --------------- | ------- | ------------------ |---|
| CS0012298 | Access to change cloud identity access and service control policies is restricted to authorized cloud administrative personnel| Identity and Access Management| Not Enabled | None |[Medium (6.8)](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:H/PR:H/UI:R/S:C/C:L/I:L/A:H)|

**Why?** <br>

By default, IAM users and roles don't have permission to create or modify Detective resources. They also can't perform tasks using the AWS Management Console, AWS CLI, or AWS API. An IAM administrator must create IAM policies that grant users and roles permission to perform specific API operations on the specified resources they need. The administrator must then attach those policies to the IAM users or groups that require those permissions. AWS Detective supports identity-based policies and service-linked roles. With IAM identity-based policies,allowed or denied actions can be specified and resources as well as the conditions under which actions are allowed or denied. A service-linked role is a unique type of IAM role that is linked directly to AWS Detective. Service-linked roles are predefined by AWS Detective and include all the permissions that the service requires to call other AWS services on users behalf.

**Following are the suggested roles for AWS Detective** <br>

| Function | Description | Role | 
| -------------- | ----------------- | --------------- | 
|  Developer | Responsible for granting identity based access to users| Custom resource role developed by IAM admin team |
| IAM admin team | This service-linked role is responsible to allow Detective to access AWS Organizations information  | AWSServiceRoleForDetective |


**How?** <br>
https://docs.aws.amazon.com/detective/latest/adminguide/security-iam.html

<br><br> 
=======
**How?**

- To use the Amazon Detective console, the user or role must have access to the relevant actions, which match corresponding actions in the API. To enable Detective and become an administrator account for a behavior graph, the user or role must be granted permission for the 'CreateGraph' action.

- To use the Detective console to perform any administrator account actions, the user or role must be granted permission for the ListGraphs action. This grants permission to retrieve the behavior graphs their account is an administrator account for. They also must be granted permission to perform specific administrator account actions.

- To use the Detective console to perform any member account actions, the user or role must be granted permission for the 'ListInvitations' action. This grants permission to view behavior graph invitations. They can then be granted permission for specific member account actions.

**Example 1 - Allowing users to view their own permissions**

This example shows how you might create a policy that allows IAM users to view the inline and managed policies that are attached to their user identity. This policy includes permissions to complete this action on the console or programmatically using the AWS CLI or AWS API.

```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "ViewOwnUserInfo",
            "Effect": "Allow",
            "Action": [
                "iam:GetUserPolicy",
                "iam:ListGroupsForUser",
                "iam:ListAttachedUserPolicies",
                "iam:ListUserPolicies",
                "iam:GetUser"
            ],
            "Resource": ["arn:aws:iam::*:user/${aws:username}"]
        },
        {
            "Sid": "NavigateInConsole",
            "Effect": "Allow",
            "Action": [
                "iam:GetGroupPolicy",
                "iam:GetPolicyVersion",
                "iam:GetPolicy",
                "iam:ListAttachedGroupPolicies",
                "iam:ListGroupPolicies",
                "iam:ListPolicyVersions",
                "iam:ListPolicies",
                "iam:ListUsers"
            ],
            "Resource": "ARN of respective resource"
        }
    ]
}
```

**Example 2 - Administrator account: Managing the member accounts in a behavior graph**

This example policy is intended for administrator account users who are only responsible for managing the member accounts used in the behavior graph. The policy also allows the user to view the usage information and deactivate Detective. The policy does not grant permission to use the behavior graph for investigation.

```json
{"Version":"2012-10-17",
  "Statement":[
   {
    "Effect":"Allow",
    "Action":["detective:ListMembers","detective:CreateMembers","detective:DeleteMembers","detective:DeleteGraph","detective:Get*","detective:StartMonitoringMember"],
    "Resource":"arn:aws:detective:us-east-1:111122223333:graph:027c7c4610ea4aacaf0b883093cab899"
  },
  {
    "Effect":"Allow",
    "Action":["detective:CreateGraph","detective:ListGraphs"],
    "Resource":"ARN of respective resource"
  }
 ]
}
```

**Example 3 - Administrator account: Using a behavior graph for investigation**

This example policy is intended for administrator account users who use the behavior graph for investigation only. They cannot view or edit the list of member accounts in the behavior graph.

```json

{"Version":"2012-10-17",
  "Statement":[
   {
    "Effect":"Allow",
    "Action":["detective:SearchGraph"],
    "Resource":"arn:aws:detective:us-east-1:111122223333:graph:027c7c4610ea4aacaf0b883093cab899"
   },
   {
    "Effect":"Allow",
    "Action":["detective:ListGraphs"],
    "Resource":"ARN of respective resource"
  }
 ]
}
```

**Example 4 - Administrator account: Restricting access based on tag values**
The following policy allows the user to use a behavior graph for investigation if the SecurityDomain tag of the behavior graph matches the SecurityDomain tag of the user.

```json

{
    "Version":"2012-10-17",
    "Statement":[ {
        "Effect":"Allow",
        "Action":["detective:SearchGraph"],
        "Resource":"arn:aws:detective:*:*:graph:*",
        "Condition": {
            "StringEquals"{
                "aws:ResourceTag/SecurityDomain": "aws:PrincipalTag/SecurityDomain"
            }
        }
    },
    {
        "Effect":"Allow",
        "Action":["detective:ListGraphs"],
        "Resource":"ARN of respective resource"
    } ]
}
```


### 2. Ensure CloudTrail logging is enabled for AWS Detective

**Security control mapping:** <br>
| Control Number | Control Statement | Security Domain | Default | Associated Runbook |CVSS Severity|
| ------------------ | ------------| --------------- | ------- | ------------------ |---|
| CS0012233| Information system must create a log and record activities occurring on or originating from the information system. Logs must be made accessible to the enterprise SIEM solution  | Security Information and event management | Not Enabled | None|[Low(2.5)](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:L/AC:H/PR:H/UI:N/S:C/C:N/I:N/A:L)|

**Why?** <br>
    
AWS Detective is integrated with AWS CloudTrail, a service that provides a record of actions taken by a user, role, or an AWS service in AWS Detective. CloudTrail captures all API calls for AWS Detective as events. The calls captured include calls from the AWS Detective console and code calls to the AWS Detective API operations. 

**How?** <br>

CloudTrail is enabled on your AWS account when you create the account. When activity occurs in Detective, that activity is recorded in a CloudTrail event, along with other AWS service events, in Event history.For an ongoing record of events in your AWS account, including events for Detective, create a trail. A trail enables CloudTrail to deliver log files to an Amazon S3 bucket.

***To create a CloudTrail trail using API :***

To create a trail that applies to all Regions, use the `--is-multi-region-trail` option. By default, the `create-trail` command creates a trail that logs events only in the AWS Region where the trail was created. To ensure that you log global service events and capture all management event activity in your AWS account, you should create trails that log events in all AWS Regions.

The following example creates a trail with the name `my-trail` and a tag with a key named `Group` with a value of `Marketing` that delivers logs from all Regions to an existing bucket named `my-bucket`.

```
aws cloudtrail create-trail --name my-trail --s3-bucket-name my-bucket --is-multi-region-trail --tags-list [key=Group,value=Marketing]
```

To confirm that your trail exists in all Regions, the `IsMultiRegionTrail` element in the `output` shows `true`.
```
{
    "IncludeGlobalServiceEvents": true, 
    "Name": "my-trail", 
    "TrailARN": "arn:aws:cloudtrail:us-east-2:123456789012:trail/my-trail", 
    "LogFileValidationEnabled": false, 
    "IsMultiRegionTrail": true, 
    "IsOrganizationTrail": false,
    "S3BucketName": "my-bucket"
}
```

>***Note***
Use the start-logging command to start logging for your trail.


<br><br> 

### 3. Ensure to send/receive invitation to Detective behavior graph only by organization owned member accounts 

**Security control mapping:** <br>
| Control Number | Control Statement | Security Domain | Default | Associated Runbook |CVSS Severity|
| ------------------ | ------------| --------------- | ------- | ------------------ |---|
| CS0012298 | Access to change cloud identity access and service control policies is restricted to authorized cloud administrative personnel | Identity & Access Management | Not Enabled | None|[Medium(5.0)](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:L/AC:H/PR:H/UI:N/S:C/C:L/I:L/A:L)|

**Why?** <br>

As per security best practice it is suggested to limit access to the behavior graph. When enterprise is inviting any member accounts to behavior graph, only invite accounts that enterprise can oversee. When a user has access to a behavior graph, they can see all of the findings for the member accounts. Such findings might expose sensitive security information. When member account receive an invitation to a behavior graph, make sure to validate the source of the invitation. Organization should check the AWS account identifier of the administrator account that sent the invitation. It should be good to verify who the account belongs to, and that the inviting account has a legitimate reason to monitor security data.

**How?** <br>

From the Detective console, you can provide a .csv file containing a list of member accounts to invite to your behavior graph.The first line in the file is the header row. Each account is then listed on a separate line. Each member account entry contains the AWS account ID and the account's root user email address.

To invite member accounts from a .csv list:

**_Step 1:_** Open the Detective console.<br>

**_Step 2:_** In the Detective navigation pane, choose **Account management**.

- Choose **Actions**. Then choose **Invite accounts**.
- Under **Add accounts**, choose Add from .csv.
- To download a template file to work from, choose **Download .csv template**.
- To select the file containing the list of accounts, choose **Choose .csv file**.<br>
  
**_Step 3:_** Under **Review member accounts**, verify the list of member accounts that Detective found in the file.<br>

**_Step 4:_** Under **Personalize invitation email**, add customized content to include in the invitation email.<br>

**_Step 5:_** **Member account IAM policy** contains the text of the required IAM policy for member accounts. The email invitation includes this policy text. To copy the policy text, choose Copy.<br>

**_Step 6:_** Choose **Invite**.

<br><br> 

### 4. Ensure only organization owned admin accounts are allowed to enable/disable AWS Detective

**Security control mapping:** <br>

| Control Number | Control Statement | Security Domain | Default | Associated Runbook |CVSS Severity|
| ------------------ | ------------| --------------- | ------- | ------------------ |---|
| CS0012298 | Access to change cloud identity access and service control policies is restricted to authorized cloud administrative personnel | Identity & Access Management | Not Enabled | None|[Medium(4.7)](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:L/AC:H/PR:H/UI:R/S:C/C:L/I:L/A:L)|

**Why?** <br>

As per security best practice it is suggested that only organization owned admin accounts should be allowed to enable/disable AWS Detective in order to protect the service from unwanted activity. When Detective is disabled, the behavior graph and its associated Detective data are deleted and once a behavior graph is deleted, it cannot be restored. So the management of this service should be controlled by right admin.

**How?** <br>

**Follow below steps to enable Detective:**

**_Step 1:_** Sign in to the AWS Management Console. Then open the Detective console at https://console.aws.amazon.com/detective/.<br>

**_Step 2:_** Choose **Get started**.<br>

**_Step 3:_** On the **Enable Amazon Detective** page, **Align administrator accounts (recommended)** explains the recommendation to align the administrator accounts between Detective and Amazon GuardDuty and AWS Security Hub.<br>

**_Step 4:_** **Attach IAM policy (required)** contains an IAM policy with the permissions that are required to enable Detective and manage a behavior graph. The policy should already be attached to your principal.

- If it is not yet attached, choose **Copy IAM policy** to copy the policy so that you can attach it.
- Confirm that the required IAM policy is in place.<br>
  
**_Step 5:_** The **Add tags** section allows you to add tags to the behavior graph.To add a tag, do the following:
- Choose **Add new tag**.
- For **Key**, enter the name of the tag.
- For **Value**, enter the value of the tag.<br>
  
**_Step 6:_** Choose **Enable Amazon Detective**.<br>

**Follow below steps to disable Detective:**

**_Step 1:_** Open the **Detective console**.<br>

**_Step 2:_** In the Detective navigation pane, under **Settings**, choose **General**.<br>

**_Step 3:_** On the **General page**, under **Disable Detective**, choose **Disable Detective**.<br>

**_Step 4:_** When prompted to confirm, type **disable**.<br>

**_Step 5:_** Choose **Disable Detective**.

<br><br> 

### 5. Ensure AWS Detective uses standard organizational resource tagging method

**Security control mapping:** <br>
| Control Number | Control Statement | Security Domain | Default | Associated Runbook |CVSS Severity|
| ------------------ | ------------| --------------- | ------- | ------------------ |---|
|CS0012128| Technology hardware and software must be registered and accurately recorded within the enterprise technology repository and/or asset management systems | Asset Management | Not Enabled | Organizational Runbook |[Low(1.6)](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:P/AC:H/PR:H/UI:N/S:U/C:N/I:N/A:L)|


**What, Why & How?** <br>

Identification of your IT assets is a crucial aspect of governance and security. You need to have visibility of all Detective resources to assess their security posture and take action on potential areas of weakness.

Tagging resources in the cloud is an easy way for teams to provide information related to who owns the resource, what the resource is used for, as well as other important information related to the deployment lifecycle of the resource. Organization has mandated that all cloud resources are to be tagged with for cross-team use.

[Place Holder for link]
<br><br> 

## Endnotes ##

### Resources 
1. https://docs.aws.amazon.com/detective/latest/adminguide/what-is-detective.html
2. https://docs.aws.amazon.com/detective/latest/adminguide/security.html

### Glossary 

**Data** - Digital pieces of information stored or transmitted for use with an information system from which understandable information is
derived. Items considered to be data are: Source code, meta-data, build artifacts, information input and output.

**Information System** - An organized assembly of resources and procedures for the collection, processing, maintenance, use, sharing,
dissemination, or disposition of information. All systems, platforms, compute instances including and not limited to physical and virtual
client endpoints, physical and virtual servers, software containers, databases, Internet of Things (IoT) devices, network devices,
applications (internal and external), Serverless computing instances (i.e. AWS Lambda), vendor provided appliances, and third-party
platforms, connected to the Capital Group network or used by Capital Group users or customers.

**Log** - a record of the events occurring within information systems and networks. Logs are composed of log entries; each entry contains
information related to a specific event that has occurred within a system or network.

**Information** - communication or representation of knowledge such as facts, data, or opinions in any medium or form, including textual,
numerical, graphic, cartographic, narrative, or audiovisual.

**Cloud Computing** - A model for enabling ubiquitous, convenient, on-demand network access to a shared pool of configurable computing
resources (e.g., networks, servers, storage, applications, and services) that can be rapidly provisioned and released with minimal
management effort or service provider interaction.

**Vulnerability**- Weakness in an information system, system security procedures, internal controls, or implementation that could be exploited
or triggered by a threat source. Note: The term weakness is synonymous for deficiency. Weakness may result in security and/or privacy
risks.
